rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // HELPER FUNCTIONS
    // ============================================
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(uid) {
      return isAuthenticated() && request.auth.uid == uid;
    }
    
    // Admin check using custom claims
    function isAdmin() {
      return request.auth != null && request.auth.token.admin == true;
    }
    
    // Check if user is a deal participant using creatorUid/participantUid fields
    function isDealParticipant(dealData) {
      return isAuthenticated() && 
        (request.auth.uid == dealData.creatorUid || 
         request.auth.uid == dealData.participantUid);
    }
    
    // Check if user is in participants array (for query compatibility)
    function isInParticipantsArray(dealData) {
      return isAuthenticated() && 
        dealData.participants != null &&
        request.auth.uid in dealData.participants;
    }
    
    // Combined participant check (supports both schema versions)
    function canAccessDeal(dealData) {
      return isDealParticipant(dealData) || isInParticipantsArray(dealData);
    }
    
    function isListingOwner(listingData) {
      return isAuthenticated() && request.auth.uid == listingData.creatorUid;
    }
    
    // ============================================
    // USERS COLLECTION
    // ============================================
    
    match /users/{uid} {
      // Admin can read all users; users can only read their own
      allow read: if isAdmin() || isOwner(uid);
      
      // Users can create their own profile
      allow create: if isOwner(uid);
      
      // Users can update their own profile (except protected fields)
      // Admin can update any user profile
      allow update: if isAdmin() || (isOwner(uid) && 
        !request.resource.data.diff(resource.data).affectedKeys()
          .hasAny(['stripeConnectAccountId', 'createdAt', 'status', 'flagsCount', 'isAdmin']));
      
      // Delete only via Cloud Functions
      allow delete: if false;
      
      // ------------------------------------------
      // USER SUBCOLLECTIONS
      // ------------------------------------------
      
      // User notifications - private to user, admin can read/create
      match /notifications/{notificationId} {
        allow read: if isAdmin() || isOwner(uid);
        allow create: if isAdmin() || isOwner(uid);
        allow update: if isOwner(uid);
        allow delete: if isOwner(uid);
      }
      
      // User connections (favorites, recent partners) - private to user
      match /connections/{connectionId} {
        allow read: if isAdmin() || isOwner(uid);
        allow write: if isOwner(uid);
      }
      
      // User activity feed - private to user
      match /activityFeed/{eventId} {
        allow read: if isAdmin() || isOwner(uid);
        allow write: if isOwner(uid);
      }
      
      // Admin notes about user - admin only
      match /adminNotes/{noteId} {
        allow read, write: if isAdmin();
      }
    }
    
    // ============================================
    // DEALS/AGREEMENTS COLLECTION
    // ============================================
    
    match /deals/{dealId} {
      // Admin can read all deals; participants can read their own
      allow read: if isAdmin() || canAccessDeal(resource.data);
      
      // CREATE: Only through Cloud Functions (to enforce validation + setup fees)
      allow create: if false;
      
      // UPDATE: Admin can update; participants can update non-sensitive fields only
      allow update: if isAdmin() || (canAccessDeal(resource.data) && 
        !request.resource.data.diff(resource.data).affectedKeys()
          .hasAny(['status', 'inviteToken', 'setupFeeCents', 'fairnessHoldA', 'fairnessHoldB', 
                   'extensionFeesTotalCents', 'stripeCheckoutSessionId', 'participantUid',
                   'creatorUid', 'participants', 'createdAt', 'cancelledAt', 'cancelledBy',
                   'adminNotes', 'adminFlags']));
      
      // DELETE: Not allowed (deals should be cancelled via Cloud Functions)
      allow delete: if false;
      
      // ------------------------------------------
      // DEAL SUBCOLLECTIONS
      // ------------------------------------------
      
      // Actions/Audit Log - read only for participants/admin, write via Cloud Functions
      match /actions/{actionId} {
        allow read: if isAdmin() || canAccessDeal(get(/databases/$(database)/documents/deals/$(dealId)).data);
        allow write: if false;
      }
      
      // Payments - read only for participants/admin, write via Cloud Functions  
      match /payments/{paymentId} {
        allow read: if isAdmin() || canAccessDeal(get(/databases/$(database)/documents/deals/$(dealId)).data);
        allow write: if false;
      }
      
      // Disputes - read only for participants/admin, write via Cloud Functions
      match /dispute/{disputeId} {
        allow read: if isAdmin() || canAccessDeal(get(/databases/$(database)/documents/deals/$(dealId)).data);
        allow write: if false;
      }
      
      // Messages/Chat - participants can read and create messages, admin can read
      match /messages/{messageId} {
        allow read: if isAdmin() || canAccessDeal(get(/databases/$(database)/documents/deals/$(dealId)).data);
        allow create: if canAccessDeal(get(/databases/$(database)/documents/deals/$(dealId)).data) &&
          request.resource.data.senderUid == request.auth.uid &&
          request.resource.data.keys().hasAll(['senderUid', 'senderEmail', 'text', 'createdAt']);
        allow update, delete: if false;
      }
      
      // Events/Activity - participants can read and create events, admin can read
      match /events/{eventId} {
        allow read: if isAdmin() || canAccessDeal(get(/databases/$(database)/documents/deals/$(dealId)).data);
        allow create: if canAccessDeal(get(/databases/$(database)/documents/deals/$(dealId)).data) &&
          request.resource.data.userId == request.auth.uid;
        allow update, delete: if false;
      }
    }
    
    // ============================================
    // MARKETPLACE LISTINGS COLLECTION  
    // ============================================
    
    match /listings/{listingId} {
      // Admin can read all; authenticated users can read active listings
      allow read: if isAdmin() || isAuthenticated();
      
      // CREATE: Authenticated users can create listings with required fields
      allow create: if isAuthenticated() &&
        request.resource.data.creatorUid == request.auth.uid &&
        request.resource.data.keys().hasAll(['title', 'description', 'type', 'creatorUid', 'status', 'createdAt']);
      
      // UPDATE: Admin can update all; owner can update (except protected fields)
      allow update: if isAdmin() || (isListingOwner(resource.data) &&
        !request.resource.data.diff(resource.data).affectedKeys()
          .hasAny(['creatorUid', 'createdAt', 'adminRemoved', 'moderationFlags']));
      
      // DELETE: Admin or owner can delete
      allow delete: if isAdmin() || isListingOwner(resource.data);
    }
    
    // ============================================
    // SUPPORT TICKETS COLLECTION
    // ============================================
    
    match /supportTickets/{ticketId} {
      // Admin can read all; users can read their own tickets
      allow read: if isAdmin() || (isAuthenticated() && resource.data.userUid == request.auth.uid);
      
      // Users can create tickets for themselves
      allow create: if isAuthenticated() && 
        request.resource.data.userUid == request.auth.uid &&
        request.resource.data.keys().hasAll(['userUid', 'userEmail', 'category', 'description', 'status', 'createdAt']);
      
      // Admin can update any ticket; users cannot update (only via functions)
      allow update: if isAdmin();
      
      // No deletes
      allow delete: if false;
      
      // Ticket messages subcollection
      match /messages/{messageId} {
        allow read: if isAdmin() || (isAuthenticated() && 
          get(/databases/$(database)/documents/supportTickets/$(ticketId)).data.userUid == request.auth.uid);
        allow create: if isAdmin() || (isAuthenticated() && 
          get(/databases/$(database)/documents/supportTickets/$(ticketId)).data.userUid == request.auth.uid);
        allow update, delete: if false;
      }
    }
    
    // ============================================
    // CASES / INVESTIGATIONS COLLECTION (Admin only)
    // ============================================
    
    match /cases/{caseId} {
      allow read, write: if isAdmin();
      
      // Case notes subcollection
      match /notes/{noteId} {
        allow read, write: if isAdmin();
      }
      
      // Case timeline subcollection
      match /timeline/{eventId} {
        allow read, write: if isAdmin();
      }
    }
    
    // ============================================
    // MODERATION CONFIG COLLECTION (Admin only)
    // ============================================
    
    match /moderationConfig/{docId} {
      // Only admin can read/write moderation config
      allow read, write: if isAdmin();
    }
    
    // ============================================
    // MODERATION FLAGS COLLECTION (Admin only)
    // ============================================
    
    match /moderationFlags/{flagId} {
      allow read, write: if isAdmin();
    }
    
    // ============================================
    // AUDIT LOGS COLLECTION
    // ============================================
    
    match /auditLogs/{logId} {
      // Admin can read all audit logs
      allow read: if isAdmin();
      
      // Write only via Cloud Functions (no direct writes)
      allow write: if false;
    }
    
    // ============================================
    // PAYMENTS COLLECTION (Top-level for admin reporting)
    // ============================================
    
    match /payments/{paymentId} {
      // Admin can read all payments; deal participants can read their own
      allow read: if isAdmin() || (isAuthenticated() && 
        (resource.data.payerUid == request.auth.uid || 
         resource.data.recipientUid == request.auth.uid));
      
      // Write only via Cloud Functions
      allow write: if false;
    }
    
    // ============================================
    // TEMPLATES COLLECTION
    // ============================================
    
    match /templates/{templateId} {
      // Templates are read-only for all authenticated users, admin can write
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // ============================================
    // ADMIN CONFIG COLLECTION (Admin only)
    // ============================================
    
    match /adminConfig/{docId} {
      allow read, write: if isAdmin();
    }
    
    // ============================================
    // STATS / ANALYTICS COLLECTION (Admin read, Functions write)
    // ============================================
    
    match /stats/{statId} {
      allow read: if isAdmin();
      allow write: if false;
    }
  }
}
